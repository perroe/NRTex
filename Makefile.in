#########################################################
# 
# This Makefile is automatically generated by configure
# The source is Makefile.in
#
#########################################################

MAIN  = nrdoc
MANUAL = manual
PRINT  = printmanual
INSTALLPATH = /nr/group/maler/nrdoc

WEBPATH = /nr/www/virtual/intern.nr.no/htdocs/drift
VERSION = <<version_number>>
PATCH   = <<patch_number>>
TGZNAME = nrtex-${VERSION}
RPMFLAGS =   --define "_sourcedir $$PWD" \
             --define "_builddir $$PWD/BUILD" \
             --define "_rpmdir $$PWD" \
             --define "_srcrpmdir $$PWD"
RPMFILE = i386/nrtex-${VERSION}-${PATCH}.i386.rpm

.SUFFIXES: .nw .tex .dvi .pdf

.SILENT: config

all:	src pdf 

config:
	configure
src:
	noweb $(MAIN).nw

dvi: 	src bib
	latex '\scrollmode \input '"$(MAIN)";\
	while ( \
	grep -s 'No file $(MAIN).toc' $(MAIN).log || \
	grep -s 'Rerun to get cross-references right'\
	$(MAIN).log ); \
	do latex '\scrollmode \input '"$(MAIN)";\
	done

bib:
	latex '\scrollmode \input '"$(MAIN)"; \
	bibtex $(MAIN)

pdf:    dvi
	dvipdfm -p a4 -o   $(MAIN).pdf $(MAIN).dvi

manual: src
	latex '\scrollmode \input '"$(MANUAL)";\
	makeindex $(MANUAL); \
	bibtex $(MANUAL); \
	latex '\scrollmode \input '"$(MANUAL)";\
	while ( \
	grep -s 'No file $(MANUAL).toc' $(MANUAL).log || \
	grep -s 'Rerun to get cross-references right'\
	$(MANUAL).log ); \
	do latex '\scrollmode \input '"$(MANUAL)"; \
	done; \
	dvipdfm -p a4 -o   $(MANUAL).pdf $(MANUAL).dvi


printmanual: src
	perl -e 'open (IFILE,"<manual.tex"); open(OFILE,">printmanual.tex"); while(<IFILE>) { s/\\documentclass\[note,screen,twoside,british,12pt\]\{nrdoc\}/\\documentclass\[note,twoside,british,12pt\]\{nrdoc\}/;print OFILE; } close(IFILE); close(OFILE)';
	latex '\scrollmode \input '"$(PRINT)";\
	makeindex $(PRINT); \
	bibtex $(PRINT); \
	latex '\scrollmode \input '"$(PRINT)";\
	while ( \
	grep -s 'No file $(PRINT).toc' $(PRINT).log || \
	grep -s 'Rerun to get cross-references right'\
	$(PRINT).log ); \
	do latex '\scrollmode \input '"$(PRINT)"; \
	done; \
	dvipdfm -p a4 -o   $(PRINT).pdf $(PRINT).dvi


html:	src
	latex2html -split 0 -no_navigation -dir manual.web -local_icons manual

install: src pdf html manual printmanual rpm
	cp nrdoc.cls $(INSTALLPATH)/	
	cp nrdoc.pdf $(INSTALLPATH)/	
	cp manual.pdf $(INSTALLPATH)/	
	cp nrplain.bst $(INSTALLPATH)/	
	cp nrunsrt.bst  $(INSTALLPATH)/		
	cp nrnorsk.bst  $(INSTALLPATH)/	
	cp nrdoc.pdf $(WEBPATH)/latex-maler/
	cp nrdoc.html $(WEBPATH)/info/latex-maler.html
	cp $(MANUAL).pdf $(WEBPATH)/latex-maler/	
	cp $(MANUAL).tex $(WEBPATH)/latex-maler/
	cp -r $(MANUAL).web/*  $(WEBPATH)/latex-maler/$(MANUAL).web/	
	cp $(PRINT).pdf $(WEBPATH)/latex-maler/
	cp $(RPMFILE) $(WEBPATH)/latex-maler/

clean:
	rm -f  *~ *.aux *.dvi \
	*.log *.pdf *.bbl *.out *.blg *.brf *.ind *.ps *.toc \
	*.idx *.lof *.ilg

tgz:	src
	mkdir -p ${TGZNAME}
	cp logos/*.pdf logos/*.eps ${MAIN}.cls $(MANUAL).pdf \
	nrunsrt.bst nrnorsk.bst  nrplain.bst ${TGZNAME}
	tar cvfz ${TGZNAME}.tar.gz ${TGZNAME}

rpm:	tgz pdf
	-rm -rf BUILD/*
	mkdir -p BUILD
	rpmbuild ${RPMFLAGS} -v -bb --clean  nrtex.spec

